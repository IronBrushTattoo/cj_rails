#+TITLE: *Iron Brush Tattoo* /Case Jewelry/
#+DATE: Tue May  3 10:45:24 CDT 2016
#+AUTHOR: AnderSon
#+OPTIONS: tags:nil

/Rails 4.2.6/

https://github.com/IronBrushTattoo/cj_rails.git
[[../../Retail_Jewelry]]

* Config

** Gemfile

   [[./Gemfile]]

   #+NAME: Gemfile
   #+begin_src ruby :tangle Gemfile :padline no
     source 'https://rubygems.org'

     gem 'rails', '4.2.6'
     gem 'pg', '~> 0.15'
     gem 'sass-rails', '~> 5.0'
     gem 'uglifier', '>= 1.3.0'
     gem 'coffee-rails', '~> 4.1.0'
     gem 'jquery-rails'
     gem 'turbolinks'
     gem 'jbuilder', '~> 2.0'
     gem 'sdoc', '~> 0.4.0', group: :doc
     gem 'dragonfly', '~> 1.0.12'
     gem 'rack-cache', :require => 'rack/cache'
     gem 'prawn'
     gem 'prawn-table', '~> 0.2.2'
     gem 'roo', '~> 2.3.2'
     gem 'chronic', '~> 0.10.2'

     group :development, :test do
       gem 'byebug'
     end

     group :development do
       gem 'web-console', '~> 2.0'
       gem 'spring'
     end
   #+end_src
   
** Gems

   [[Dragonfly]]
   [[Prawn]]

* First steps :rails_template:rails:rake:

  : rake db:migrate
  : rake db:setup
* Project

  The purpose of this application is to produce several pdf files from an xlsx file,
  as a re-implementation of https://github.com/IronBrushTattoo/cj as a web 
  application.

** User Story

   - user logs in ([[Authentication]])
   - chooses xlsx file for upload
     [[File Upload]]
   - selects number of days back to make labels from
   - submits
     - BACKGROUND
       - cj-parser.rb does what it does...
         - [ ] rewrite in rails?
   - downloads sheets(pdf files)

** File Upload

   - possible gems
     https://www.ruby-toolbox.com/categories/rails_file_uploads
     
     - paperclip
       - nb
         - used paperclip before
         - seemed to be designed specifically for image files
         - always worked well
     - carrierwave
       - nb
         - used before, but not thoroughly
           - i kind of remember having issues with it
     - dragonfly
       https://github.com/markevans/dragonfly
       http://markevans.github.io/dragonfly/
       http://markevans.github.io/dragonfly/rails/

       Dragonfly is a highly customizable ruby gem for handling images and other
       attachments and is already in use on thousands of websites

       [[Dragonfly]]

       - nb
         - used briefly before
           - i remember it being an easy configuration
     - attachment fu
       https://github.com/technoweenie/attachment_fu
       
       Treat an ActiveRecord model as a file attachment, storing its patch, size,
       content type, etc. http://weblog.technoweenie.net

       - nb
         - has not been maintained since Apr 25, 2009
     - refile
       - nb
         - was my next choice when previously working with file uploads
     - jquery.fileupload-rails
     - imagery
     - attached
     - papermill
     - fileuploader-rails
     - filecip
     - simple-image-uploader

*** Dragonfly
    
    http://markevans.github.io/dragonfly/rails/

**** Setup
     
     - [X] gem 'dragonfly', '~> 1.0.12'

       - [X] modify [[Gemfile]]

       - [X] bundle install

     - [X] rails g dragonfly

       generates config/initializers/dragonfly.rb

       [[./config/initializers/dragonfly.rb]]

       #+begin_src ruby :tangle config/initializers/dragonfly.rb :padline no
         require 'dragonfly'

         # Configure
         Dragonfly.app.configure do
           plugin :imagemagick

           secret "72245c7371d66ccca6f9356779fa16e3104e6676c1e57af987e9e3f92130dca5"

           url_format "/media/:job/:name"

           datastore :file,
             root_path: Rails.root.join('public/system/dragonfly', Rails.env),
             server_root: Rails.root.join('public')
         end

         # Logger
         Dragonfly.logger = Rails.logger

         # Mount as middleware
         Rails.application.middleware.use Dragonfly::Middleware

         # Add model functionality
         if defined?(ActiveRecord::Base)
           ActiveRecord::Base.extend Dragonfly::Model
           ActiveRecord::Base.extend Dragonfly::Model::Validations
         end
       #+end_src

**** Handling attachments

     - example (replace Photo model with Spreadsheet)
       
       Model: /Photo/
       
       - add /image/ attribute to Photo

         : class Photo < ActiveRecord::Base
         :   dragonfly_accessor :image  # defines a reader/writer for image
         :   # ...
         : end

       - needs /image_uid/ column, create migration with

         : rails g migration 
         
         : add_column :photos, :image_uid, :string
         : add_column :photos, :image_name, :string  # Optional - if you want 
         :                                           # urls to end with the 
         :                                           # original filename

       - view for uploading

         : app/views/photos/...

         : <% form_for @photo do |f| %>
         :   ...
         :   <%= f.file_field :image %>
         :   ...
         : <% end %>
         
       - allow parameter /image/ to be accepted by the controller

         : app/controllers/photos_controller.rb

         : params.require(:photo).permit(:image)

       - view for displaying

         : <%= image_tag @photo.image.thumb('400x200#').url if @photo.image_stored? %>

       - more can be done with [[http://markevans.github.io/dragonfly/models][models]]

     - Spreadsheet model sketch based on above example
       
       Model: /Spreadsheet/

       [[Spreadsheet]]
       
       - [X] add /file/ attribute to Spreadsheet

         : class Spreadsheet < ActiveRecord::Base
         :   dragonfly_accessor :file  # defines a reader/writer for file
         :   # ...
         : end

       - [X] needs /file_uid/ column, create migration with
         
         : rails g migration AddFileUidToSpreadsheets file_uid:string
         : rails g migration AddFileNameToSpreadsheets file_name:string

         [[./db/migrate/20160504011342_add_file_uid_to_spreadsheets.rb]]
         [[./db/migrate/20160504011542_add_file_name_to_spreadsheets.rb]]

         : add_column :spreadsheets, :file_uid, :string
         : add_column :spreadsheets, :file_name, :string  # Optional - if you want 
         :                                                # urls to end with the 
         :                                                # original filename

         : rake db:migrate

       - [X] view for uploading

         [[./app/views/spreadsheets/]]

         : <% form_for @spreadsheet do |f| %>
         :   ...
         :   <%= f.file_field :file %>
         :   ...
         : <% end %>
         
       - [X] allow parameter /file/ to be accepted by the controller

         [[./app/controllers/spreadsheets_controller.rb]]

         : params.require(:spreadsheet).permit(:file)

         [[SpreadsheetPdf]]

         #+NAME: spreadsheets controller
         #+begin_src ruby :tangle app/controllers/spreadsheets_controller.rb :padline no
           class SpreadsheetsController < ApplicationController
             before_action :set_spreadsheet, only: [:show, :edit, :update, :destroy]

             def index
               @spreadsheets = Spreadsheet.all
             end

             def show
               @spreadsheet = Spreadsheet.find(params[:id])
               respond_to do |format|
                 format.html
                 format.pdf do
                   pdf = SpreadsheetPdf.new(@spreadsheet, view_context)
                   send_data pdf.render,
                             filename: "spreadsheet_#{@spreadsheet.created_at.strftime("%d/%m/%Y")}.pdf",
                             type: "application/pdf",
                             disposition: "inline"
                 end
               end
             end

             def new
               @spreadsheet = Spreadsheet.new
             end

             def edit
             end

             def create
               @spreadsheet = Spreadsheet.new(spreadsheet_params)

               respond_to do |format|
                 if @spreadsheet.save
                   format.html { redirect_to @spreadsheet, notice: 'Spreadsheet was successfully created.' }
                   format.json { render :show, status: :created, location: @spreadsheet }
                 else
                   format.html { render :new }
                   format.json { render json: @spreadsheet.errors, status: :unprocessable_entity }
                 end
               end
             end

             def update
               respond_to do |format|
                 if @spreadsheet.update(spreadsheet_params)
                   format.html { redirect_to @spreadsheet, notice: 'Spreadsheet was successfully updated.' }
                   format.json { render :show, status: :ok, location: @spreadsheet }
                 else
                   format.html { render :edit }
                   format.json { render json: @spreadsheet.errors, status: :unprocessable_entity }
                 end
               end
             end

             def destroy
               @spreadsheet.destroy
               respond_to do |format|
                 format.html { redirect_to spreadsheets_url, notice: 'Spreadsheet was successfully destroyed.' }
                 format.json { head :no_content }
               end
             end

             private
             def set_spreadsheet
               @spreadsheet = Spreadsheet.find(params[:id])
             end

             def spreadsheet_params
               params.require(:spreadsheet).permit(:index, :file, :days)
             end
           end

         #+end_src

         - nb
           
           [[Prawn]]
           [[Creating PDF Using Prawn in Ruby on Rails]]

       - [X] view for displaying

         [[./app/views/spreadsheets/show.html.erb]]
         [[./app/views/spreadsheets/index.html.erb]]

         : <%= @spreadsheet.file_name if @spreadsheet.file_stored? %>

       - more can be done with [[http://markevans.github.io/dragonfly/models][models]]

**** Caching

     - [X] [[Gemfile]]

       : gem 'rack-cache', :require => 'rack/cache'

       - [X] bundle install

     - [X] uncomment in [[Production]]

       : config.action_dispatch.rack_cache = true

**** Custom Endpoints

     [[Routes]]

     - [ ] text generation example
       
       : get "text/:text" => Dragonfly.app.endpoint { |params, app|
       :   app.generate(:text, params[:text], 'font-size' => 42)
       : }

     - [ ] endpoint callable from javascript (e.g. /image?file=egg.png&size=30x30)

       : get "image" => Dragonfly.app.endpoint { |params, app|
       :   app.fetch_file("some/dir/#{params[:file]}").thumb(params[:size])
       : }

**** Using Another Data Store

     http://www.sitepoint.com/file-uploads-dragonfly/

     - [ ] add [[./public/system/dragonfly]] to [[./.gitignore]]

       #+NAME: gitignore
       #+begin_src text :tangle .gitignore :padline no
         # See https://help.github.com/articles/ignoring-files for more about ignoring files.
         #
         # If you find yourself ignoring temporary files generated by your text editor
         # or operating system, you probably want to add a global ignore instead:
         #   git config --global core.excludesfile '~/.gitignore_global'

         # Ignore bundler config.
         /.bundle

         # Ignore all logfiles and tempfiles.
         /log/*
         !/log/.keep
         /tmp

         /public/system/dragonfly
       #+end_src

** File Conversion

*** xlsx processing

**** Roo

     https://github.com/roo-rb/roo

     - [X] [[Gemfile]]

       : gem 'roo', '~> 2.3.2'

       - [X] bundle install

     - [ ] examine code from native application

       [[~/IBT/jewelry/Retail_Jewelry/cj-parser.rb]]

       #+NAME: cj-parser-scratch
       #+begin_src text

       : require 'roo'
       : 
       : def get_labels(file)
       :   puts "getting labels"
       :   
       :   labels = []
       :   
       :   xls_file = Roo::Spreadsheet.open(file)
       : 
       :   xls_file.sheets.each do |sheet|
       : 
       :     sheet = xls_file.sheet(sheet)
       :     
       :     sheet.parse[4..-1].each do |row|
       : 
       :       zero,one,two,four,five,ten = nil_convert(row[0]),
       :       nil_convert(row[1]),
       :       nil_convert(row[2]),
       :       nil_convert(row[4]),
       :       nil_convert(row[5]),
       :       nil_convert(row[10])
       : 
       :       sizes = strip(five.to_s)
       :       gauge = "#{sizes[0]}g"
       :       size = "#{sizes[1]}\""
       :       desc = two.gsub("&", "and")
       :       id = one.to_s.split(/-/)[0]
       :       price = "$#{four.to_s.split(".")[0]}"
       :       supply = five
       :       updated = Chronic.parse(ten).to_f
       : 
       :       label = Label.new(gauge,
       :                         size,
       :                         desc,
       :                         id,
       :                         price,
       :                         supply,
       :                         updated
       :                        )
       : 
       :       seconds = 60*60*24*$days
       :       
       :       if (Time.now.to_f - updated.to_f) < seconds
       :         puts label.id
       :         $labelID = label.id
       :         labels.push label
       :       end
       : 
       :     end
       :   end
       : 
       :   return labels
       : 
       : end
       #+end_src

*** pdf processing

**** Prawn
     https://github.com/prawnpdf/prawn

***** Setup

     - [X] [[Gemfile]]
     : #gem 'prawn', '~> 2.1'
     : gem 'prawn'

     - [X] bundle install

****** Manual

       http://prawnpdf.org/manual.pdf

       - [X] clone repository

         : git clone https://github.com/prawnpdf/prawn

       - [ ] switch to the stable branch 

         : git branch stable
         
       - [X] bundle install

       - [ ] bundle exec rake manual
         generates /manual.pdf/ in the project root
    
***** Tutorials
****** Creating PDF Using Prawn in Ruby on Rails

       http://www.idyllic-software.com/blog/creating-pdf-using-prawn-in-ruby-on-rails/

       - [X] [[Gemfile]]

         : gem 'prawn'
         : bundle install

       - [X] [[./config/initializers/mime_types.rb]]

         create a PDF Mime::Type inside mime_types.rb

         #+NAME: mime_types.rb
         #+begin_src ruby :tangle config/initializers/mime_types.rb
           # Be sure to restart your server when you modify this file.

           # Add new mime types for use in respond_to blocks:
           # Mime::Type.register "text/richtext", :rtf

           Mime::Type.register "application/pdf", :pdf
         #+end_src

       - [X] [[./app/controllers/spreadsheets_controller.rb]]

         [[Spreadsheets]]
         
         http://www.idyllic-software.com/blog/creating-pdf-using-prawn-in-ruby-on-rails/
         
         : class InvoicesController < ApplicationController
         :
         :   before_filter :authenticate_customer!, :only => [:index, :show]
         :
         :   def index
         :     @invoices = Invoice.all_invoices(current_customer)
         :   end
         :
         :   def show
         :     @invoice = Invoice.find(params[:id])
         :     respond_to do |format|
         :       format.html
         :       format.pdf do
         :         pdf = InvoicePdf.new(@invoice, view_context)
         :         send_data pdf.render, filename: 
         :           "invoice_#{@invoice.created_at.strftime("%d/%m/%Y")}.pdf",
         :           type: "application/pdf"
         :       end
         :     end
         :   end
         : 
         : end

         - [X] open pdf in browser instead of download

           add /disposition: "inline"/ after type

       - [X] create a new class *app/pdfs/spreadsheet_pdf*
         
         [[SpreadsheetPdf]]

         [[Spreadsheets]]

       - [X] restart server

       - [X] [[SpreadsheetPdf]]

         set the /@spreadsheet/ and /view_context/

         : def initialize(spreadsheet, view)
         :   super()
         :   @spreadsheet = spreadsheet
         :   @view = view
         :   text "Spreadsheet #{@spreadsheet.id}"
         : end

       - [ ] create different methods inside [[SpreadsheetPdf]] as per what you want to show on the pdf

         - example

           : def logo
           :   logopath = "#{Rails.root}/app/assets/images/logo.png"
           :   image logopath, :width => 197, :height => 91
           : end
       
******* Issues

        - [ ] NameError (uninitialized constant SpreadsheetsController::SpreadsheetPdf)
      
**** nb
      https://rubygems.org/search?utf8=%E2%9C%93&query=latex
      http://www.sitepoint.com/hackable-pdf-typesetting-in-ruby-with-prawn/
      
      https://github.com/prawnpdf/prawn

      [[Prawn]] is active and looks rad!

      - outdated but possibly useful

        https://github.com/baierjan/rails-latex
        https://github.com/bruce/rtex
   
** Authentication

*** AuthO

    On October 6, 2015 the European Court of Justice invalidated the Safe Harbor treaty that prescribed privacy protections for EU residents. Auth0 was and remains compliant with Safe Harbor terms, but due to the invalidation now further commits to the EU Commission’s standard Model Contract Clauses (below) for personal data. Because you do or may have Auth0 process EU users, to use Auth0’s service you must now affirmatively agree to these Model Contract Clauses by checking the box below.
    Please carefully review these European Commission Standard Contractual Clauses (processors), because it is a binding legal document. The data exporter (you) consents and agrees that (i) it is the controller of personal data transferred from the European Economic Area (EEA) to the United States or other countries not deemed to provide adequate security for such data, and (ii) an electronic signature (manifested by clicking "Accept"), meets the requirements of an original signature as if actually signed in writing. At the request of data importer (Auth0), any electronically signed document must be re-executed by data exporter in original form. No party hereto may raise the use of an electronic signature as a defense to the enforcement of these clauses. Standard Contractual Clauses (processors) For the purposes of Article 26(2) of Directive 95/46/EC for the transfer of personal data to processors established in third countries which do not ensure an adequate level of data protection, the non-Auth0 legal entity accepting the Clauses (the “Data Exporter”) and Auth0 Inc., 10777 Main Street, Suite 204, Bellevue, WA, 98004, USA (the “Data Importer”) each a “party”; together “the parties”, HAVE AGREED on the following Contractual Clauses (the “Clauses”) in order to adduce adequate safeguards with respect to the protection of privacy and fundamental rights and freedoms of individuals for the transfer by the data exporter to the data importer of the personal data specified in Appendix 1. The Clauses (including Appendices 1 and 2) are effective from the date the non-Auth0 entity has both: (i) executed a valid “Auth0 Service Agreement” (collectively the “Services Agreement”) or is otherwise an authorized customer affiliate under such Services Agreement; and (ii) clicked to accept these Clauses. A “Auth0 Service Agreement” means an Auth0 Service Agreement entered into with Auth0 Inc.,. If you are accepting on behalf of the Data Exporter, you represent and warrant that: (i) you have full legal authority to bind your employer, or the applicable entity, to these terms and conditions; (ii) you have read and understand the Clauses; and (iii) you agree, on behalf of the party that you represent, to the Clauses. If you do not have the legal authority to bind the Data Exporter, please do not click the “Accept” button below. The Clauses shall automatically expire on the termination or expiry of the Auth0 Service Agreement. The parties agree that where Data Exporter has been presented with these Clauses and clicked to accept these terms electronically, such acceptance shall constitute execution of the entirety of the Clauses by both parties, subject to the effective date described above. Clause 1 Definitions For the purposes of the Clauses: (a) 'personal data', 'special categories of data', 'process/processing', 'controller', 'processor', 'data subject' and 'supervisory authority' shall have the same meaning as in Directive 95/46/EC of the European Parliament and of the Council of 24 October 1995 on the protection of individuals with regard to the processing of personal data and on the free movement of such data[1]; (b) 'the data exporter' means the controller who transfers the personal data; (c) 'the data importer' means the processor who agrees to receive from the data exporter personal data intended for processing on his behalf after the transfer in accordance with his instructions and the terms of the Clauses and who is not subject to a third country's system ensuring adequate protection within the meaning of Article 25(1) of Directive 95/46/EC; (d) 'the subprocessor' means any processor engaged by the data importer or by any other subprocessor of the data importer who agrees to receive from the data importer or from any other subprocessor of the data importer personal data exclusively intended for processing activities to be carried out on behalf of the data exporter after the transfer in accordance with his instructions, the terms of the Clauses and the terms of the written subcontract; (e) 'the applicable data protection law' means the legislation protecting the fundamental rights and freedoms of individuals and, in particular, their right to privacy with respect to the processing of personal data applicable to a data controller in the Member State in which the data exporter is established; (f) 'technical and organisational security measures' means those measures aimed at protecting personal data against accidental or unlawful destruction or accidental loss, alteration, unauthorised disclosure or access, in particular where the processing involves the transmission of data over a network, and against all other unlawful forms of processing. Clause 2 Details of the transfer The details of the transfer and in particular the special categories of personal data where applicable are specified in Appendix 1 which forms an integral part of the Clauses. Clause 3 Third-party beneficiary clause 1. The data subject can enforce against the data exporter this Clause, Clause 4(b) to (i), Clause 5(a) to (e), and (g) to (j), Clause 6(1) and (2), Clause 7, Clause 8(2), and Clauses 9 to 12 as third-party beneficiary. 2. The data subject can enforce against the data importer this Clause, Clause 5(a) to (e) and (g), Clause 6, Clause 7, Clause 8(2), and Clauses 9 to 12, in cases where the data exporter has factually disappeared or has ceased to exist in law unless any successor entity has assumed the entire legal obligations of the data exporter by contract or by operation of law, as a result of which it takes on the rights and obligations of the data exporter, in which case the data subject can enforce them against such entity. 3. The data subject can enforce against the subprocessor this Clause, Clause 5(a) to (e) and (g), Clause 6, Clause 7, Clause 8(2), and Clauses 9 to 12, in cases where both the data exporter and the data importer have factually disappeared or ceased to exist in law or have become insolvent, unless any successor entity has assumed the entire legal obligations of the data exporter by contract or by operation of law as a result of which it takes on the rights and obligations of the data exporter, in which case the data subject can enforce them against such entity. Such third-party liability of the subprocessor shall be limited to its own processing operations under the Clauses. 4. The parties do not object to a data subject being represented by an association or other body if the data subject so expressly wishes and if permitted by national law. Clause 4 Obligations of the data exporter The data exporter agrees and warrants: (a) that the processing, including the transfer itself, of the personal data has been and will continue to be carried out in accordance with the relevant provisions of the applicable data protection law (and, where applicable, has been notified to the relevant authorities of the Member State where the data exporter is established) and does not violate the relevant provisions of that State; (b) that it has instructed and throughout the duration of the personal data processing services will instruct the data importer to process the personal data transferred only on the data exporter's behalf and in accordance with the applicable data protection law and the Clauses; (c) that the data importer will provide sufficient guarantees in respect of the technical and organisational security measures specified in Appendix 2 to this contract; (d) that after assessment of the requirements of the applicable data protection law, the security measures are appropriate to protect personal data against accidental or unlawful destruction or accidental loss, alteration, unauthorised disclosure or access, in particular where the processing involves the transmission of data over a network, and against all other unlawful forms of processing, and that these measures ensure a level of security appropriate to the risks presented by the processing and the nature of the data to be protected having regard to the state of the art and the cost of their implementation; (e) that it will ensure compliance with the security measures; (f) that, if the transfer involves special categories of data, the data subject has been informed or will be informed before, or as soon as possible after, the transfer that its data could be transmitted to a third country not providing adequate protection within the meaning of Directive 95/46/EC; (g) to forward any notification received from the data importer or any subprocessor pursuant to Clause 5(b) and Clause 8(3) to the data protection supervisory authority if the data exporter decides to continue the transfer or to lift the suspension; (h) to make available to the data subjects upon request a copy of the Clauses, with the exception of Appendix 2, and a summary description of the security measures, as well as a copy of any contract for subprocessing services which has to be made in accordance with the Clauses, unless the Clauses or the contract contain commercial information, in which case it may remove such commercial information; (i) that, in the event of subprocessing, the processing activity is carried out in accordance with Clause 11 by a subprocessor providing at least the same level of protection for the personal data and the rights of data subject as the data importer under the Clauses; and (j) that it will ensure compliance with Clause 4(a) to (i). Clause 5 Obligations of the data importer[2] The data importer agrees and warrants: (a) to process the personal data only on behalf of the data exporter and in compliance with its instructions and the Clauses; if it cannot provide such compliance for whatever reasons, it agrees to inform promptly the data exporter of its inability to comply, in which case the data exporter is entitled to suspend the transfer of data and/or terminate the contract; (b) that it has no reason to believe that the legislation applicable to it prevents it from fulfilling the instructions received from the data exporter and its obligations under the contract and that in the event of a change in this legislation which is likely to have a substantial adverse effect on the warranties and obligations provided by the Clauses, it will promptly notify the change to the data exporter as soon as it is aware, in which case the data exporter is entitled to suspend the transfer of data and/or terminate the contract; (c) that it has implemented the technical and organisational security measures specified in Appendix 2 before processing the personal data transferred; (d) that it will promptly notify the data exporter about: (i) any legally binding request for disclosure of the personal data by a law enforcement authority unless otherwise prohibited, such as a prohibition under criminal law to preserve the confidentiality of a law enforcement investigation, (ii) any accidental or unauthorised access, and (iii)	any request received directly from the data subjects without responding to that request, unless it has been otherwise authorised to do so; (e) to deal promptly and properly with all inquiries from the data exporter relating to its processing of the personal data subject to the transfer and to abide by the advice of the supervisory authority with regard to the processing of the data transferred; (f) at the request of the data exporter to submit its data processing facilities for audit of the processing activities covered by the Clauses which shall be carried out by the data exporter or an inspection body composed of independent members and in possession of the required professional qualifications bound by a duty of confidentiality, selected by the data exporter, where applicable, in agreement with the supervisory authority; (g) to make available to the data subject upon request a copy of the Clauses, or any existing contract for subprocessing, unless the Clauses or contract contain commercial information, in which case it may remove such commercial information, with the exception of Appendix 2 which shall be replaced by a summary description of the security measures in those cases where the data subject is unable to obtain a copy from the data exporter; (h) that, in the event of subprocessing, it has previously informed the data exporter and obtained its prior written consent; (i) that the processing services by the subprocessor will be carried out in accordance with Clause 11; (j) to send promptly a copy of any subprocessor agreement it concludes under the Clauses to the data exporter. Clause 6 Liability 1. The parties agree that any data subject, who has suffered damage as a result of any breach of the obligations referred to in Clause 3 or in Clause 11 by any party or subprocessor is entitled to receive compensation from the data exporter for the damage suffered. 2. If a data subject is not able to bring a claim for compensation in accordance with paragraph 1 against the data exporter, arising out of a breach by the data importer or his subprocessor of any of their obligations referred to in Clause 3 or in Clause 11, because the data exporter has factually disappeared or ceased to exist in law or has become insolvent, the data importer agrees that the data subject may issue a claim against the data importer as if it were the data exporter, unless any successor entity has assumed the entire legal obligations of the data exporter by contract of by operation of law, in which case the data subject can enforce its rights against such entity. The data importer may not rely on a breach by a subprocessor of its obligations in order to avoid its own liabilities. 3. If a data subject is not able to bring a claim against the data exporter or the data importer referred to in paragraphs 1 and 2, arising out of a breach by the subprocessor of any of their obligations referred to in Clause 3 or in Clause 11 because both the data exporter and the data importer have factually disappeared or ceased to exist in law or have become insolvent, the subprocessor agrees that the data subject may issue a claim against the data subprocessor with regard to its own processing operations under the Clauses as if it were the data exporter or the data importer, unless any successor entity has assumed the entire legal obligations of the data exporter or data importer by contract or by operation of law, in which case the data subject can enforce its rights against such entity. The liability of the subprocessor shall be limited to its own processing operations under the Clauses. Clause 7 Mediation and jurisdiction 1. The data importer agrees that if the data subject invokes against it third-party beneficiary rights and/or claims compensation for damages under the Clauses, the data importer will accept the decision of the data subject: (a) to refer the dispute to mediation, by an independent person or, where applicable, by the supervisory authority; (b) to refer the dispute to the courts in the Member State in which the data exporter is established. 2. The parties agree that the choice made by the data subject will not prejudice its substantive or procedural rights to seek remedies in accordance with other provisions of national or international law. Clause 8 Cooperation with supervisory authorities 1. The data exporter agrees to deposit a copy of this contract with the supervisory authority if it so requests or if such deposit is required under the applicable data protection law. 2. The parties agree that the supervisory authority has the right to conduct an audit of the data importer, and of any subprocessor, which has the same scope and is subject to the same conditions as would apply to an audit of the data exporter under the applicable data protection law. 3. The data importer shall promptly inform the data exporter about the existence of legislation applicable to it or any subprocessor preventing the conduct of an audit of the data importer, or any subprocessor, pursuant to paragraph 2. In such a case the data exporter shall be entitled to take the measures foreseen in Clause 5 (b). Clause 9 Governing Law The Clauses shall be governed by the law of the Member State in which the data exporter is established. Clause 10 Variation of the contract The parties undertake not to vary or modify the Clauses. This does not preclude the parties from adding clauses on business related issues where required as long as they do not contradict the Clause. Clause 11 Subprocessing 1. The data importer shall not subcontract any of its processing operations performed on behalf of the data exporter under the Clauses without the prior written consent of the data exporter. Where the data importer subcontracts its obligations under the Clauses, with the consent of the data exporter, it shall do so only by way of a written agreement with the subprocessor which imposes the same obligations on the subprocessor as are imposed on the data importer under the Clauses[3]. Where the subprocessor fails to fulfil its data protection obligations under such written agreement the data importer shall remain fully liable to the data exporter for the performance of the subprocessor's obligations under such agreement. 2. The prior written contract between the data importer and the subprocessor shall also provide for a third-party beneficiary clause as laid down in Clause 3 for cases where the data subject is not able to bring the claim for compensation referred to in paragraph 1 of Clause 6 against the data exporter or the data importer because they have factually disappeared or have ceased to exist in law or have become insolvent and no successor entity has assumed the entire legal obligations of the data exporter or data importer by contract or by operation of law. Such third-party liability of the subprocessor shall be limited to its own processing operations under the Clauses. 3. The provisions relating to data protection aspects for subprocessing of the contract referred to in paragraph 1 shall be governed by the law of the Member State in which the data exporter is established. 4. The data exporter shall keep a list of subprocessing agreements concluded under the Clauses and notified by the data importer pursuant to Clause 5 (j), which shall be updated at least once a year. The list shall be available to the data exporter's data protection supervisory authority. Clause 12 Obligation after the termination of personal data processing services 1. The parties agree that on the termination of the provision of data processing services, the data importer and the subprocessor shall, at the choice of the data exporter, return all the personal data transferred and the copies thereof to the data exporter or shall destroy all the personal data and certify to the data exporter that it has done so, unless legislation imposed upon the data importer prevents it from returning or destroying all or part of the personal data transferred. In that case, the data importer warrants that it will guarantee the confidentiality of the personal data transferred and will not actively process the personal data transferred anymore. 2. The data importer and the subprocessor warrant that upon request of the data exporter and/or of the supervisory authority, it will submit its data processing facilities for an audit of the measures referred to in paragraph 1. [1] Parties may reproduce definitions and meanings contained in Directive 95/46/EC within this Clause if they considered it better for the contract to stand alone. [2] Mandatory requirements of the national legislation applicable to the data importer which do not go beyond what is necessary in a democratic society on the basis of one of the interests listed in Article 13(1) of Directive 95/46/EC, that is, if they constitute a necessary measure to safeguard national security, defence, public security, the prevention, investigation, detection and prosecution of criminal offences or of breaches of ethics for the regulated professions, an important economic or financial interest of the State or the protection of the data subject or the rights and freedoms of others, are not in contradiction with the standard contractual clauses. Some examples of such mandatory requirements which do not go beyond what is necessary in a democratic society are, inter alia, internationally recognised sanctions, tax-reporting requirements or anti-money-laundering reporting requirements. [3] This requirement may be satisfied by the subprocessor co-signing the contract entered into between the data exporter and the data importer under this Decision. Appendix 1 Appendix 1 to the Standard Contractual Clauses This Appendix forms part of the Clauses of the Standard Contractual Clauses and is to be considered as part of any agreement to the Standard Contractual Clauses. Data Exporter The data exporter has purchased authentication Services from the data importer which include the processing of personal data. Data Importer The Data Importer, a global provider of technology services for businesses, has agreed to provide authentication Services to data exporter (on a software-as-a-service basis) including the processing of personal data. Data Subjects The personal data transferred by the data exporter to the data importer concerns the following categories of data subjects: Data exporter’s customers and end-users Data exporter’s employees, consultant and agents authorized by data exporter to use the Services and/or identified to serve as customer contacts. . Categories of data Data exporter may provide names, emails, street addresses, and phone numbers with respect to its employees, consultants and agents authorized by data exporter to use the Services and/or identified to serve as customer contacts. Data exporter selects the categories of data collected by, and/or provided to, data importer for purposes of providing the authentication Services and related processing. All these activities are conducted electronically, so data importer has no visibility into the selections by data exporter, but assumes that the categories of data would be those commonly used for authentication purposes, such as log-in credentials, first name, last name and email address. Special categories of data (if appropriate) Not applicable. Processing operations The personal data transferred will be subject to the following basic processing activities: Scope of Processing. Personal data may be processed only to comply with Instructions by (or at the direction of) Data Exporter (and as defined in the Terms of Service or Service Agreement) in order to provide the Services. Storage Personal data will be stored by data importer. Access Data exporter will have the ability to configure the Services, access, correct, block, export and delete data from the Services in accordance with the Terms of Service or Service Agreement. Termination After termination or expiry of the applicable Services Agreement, data importer will delete the data exporter’s data from the Service. Appendix 2 Appendix 2 to the Standard Contractual Clauses This Appendix forms part of the Clauses of the Standard Contractual Clauses and is considered to be part of any agreement to the Standard Contractual Clauses. Description of the technical and organisational security measures implemented by the Data Importer in accordance with Clauses 4(c) and 5(c) (or document/legislation attached): The Data Importer currently abides by the security standards in this Appendix 2. The Data Importer may update or modify these security standards from time to time provided such updates and modifications will not result in a degradation of the overall security of the Services during the term of the Service Agreement. 1. Hosting Infrastructure. Infrastructure. The Data Importer hosts its services in geographically distributed, secure data centers operated by Amazon Web Services (AWS) and Microsoft Azure. Redundancy. The services are replicated across multiple data centers within a geographic region to eliminate single points of failure using an active/passive configuration in order to minimize the impact of environmental risks. Monitoring. The services are protected by automated monitoring which is designed to detect a variety of failure conditions and which will, when appropriate, trigger failover mechanisms. Backups. Backups are performed on a regular basis and stored in a secondary site within the same geographic region. Business Continuity. The Data Importer replicates its service and data over multiple data centers within a geographic region to protect against loss of service or data. The Data Importer conducts periodic tests of failover and data backup procedures to ensure readiness for business continuity and disaster recovery. 2. Networks & Transmission. Network Data Transmission. All interactions between users, administrators and Auth0 modules are done using the Secure Socket Layer (SSL) or Transport Layer Security (TLS) standard cryptographic protocols. Network Security. The Data Importer employs multiple layers of DOS protection, Intrusion Detection, Rate Limiting and other network security services from both its hosting providers and third party providers. Encryption Technologies. The Data Importer makes HTTPS encryption (also referred to as SSL or TLS connection) available. 3. Policies and Procedures Policies. The Data Importer has written, approved policies governing Account Management, Acceptable Use, Data Retention, Employee Code of Conduct, Encryption, Incident Response, Information Sensitivity, Use of Mobile Devices, Password Protection, Patch Management and Risk Management. Procedures. The Data Importer has written and approved procedures for Data Breach Notification, Change Management, Communication, Disaster Recovery, DoS Response, System Backup and Recovery, and Monitoring. Security Response. The Data Importer monitors a variety of communication channels for security incidents, and the Data Importer’s security personnel will react promptly to known incidents. 4. Access Controls. Access Procedures. The Data Importer maintains formal access procedures for allowing access to the production service and components involved in building the production service. Only authorized employees are allowed access to these restricted components and all access is approved by an employee’s manager and service owner. Only a small number of individuals are approved to access the restricted components. Audit records are maintained to indicate who has access to restricted components. Access Mechanisms. Access to the Data Importer’s production service and build infrastructure occurs only over a secured channel and require two-factor authentication. Logging. Access to the Data Importer’s production service and build infrastructure is done using unique IDs and is logged. Infrastructure Security Personnel. The Data Importer maintains several security policies governing its personnel. The Data Importer’s infrastructure security personnel are responsible for the ongoing monitoring of the Data Importer’s security infrastructure, the review of the Services, and responding to security incidents. . 5. Data Protection. In Transit. All interactions between users, administrators and Auth0 modules are done using the Secure Socket Layer (SSL) or Transport Layer Security (TLS) standard cryptographic protocols At Rest. The Data Importer uses cryptographic hashing and encryption mechanisms to protect sensitive information such as cryptographic keys and application secrets. Redundancy. The Data Importer stores data in a multi-tenant environment within the Data Importer’s hosted infrastructure. The data and service are replicated across multiple hosted datacenters within the same geographic region. Data Isolation. The Data Importer logically isolates the Data Exporter’s data, and the Data Exporter has a large degree of control over the specific data stored in the Service. Data Deletion. The Data Importer provides to the Data Exporter a mechanism that can be used to delete the Data Exporter’s data. 6. Software Code Review. The Data Importer employs a code review process to improve the security of the code used to provide the Services. All changes to the service are reviewed and approved by a senior engineer other than the author of the change. Automated testing. Each software build is subjected to a comprehensive suite of automated tests. Security Scan. The Data Importer employs a third party to scan the Service for security vulnerabilities on a periodic basis. 7. Staff Conduct and Security. Staff Conduct. The Data Importer personnel are required to conduct themselves in a manner consistent with the company’s guidelines regarding confidentiality, business ethics, usage, compliance and professional standards. Background Checks. The Data Importer conducts reasonably appropriate backgrounds checks to the extent legally permissible and in accordance with applicable local labor law and statutory regulations. 8. Subprocessor Security. Prior to onboarding Subprocessors that will handle any data provided by a Data Exporter, the Data Importer conducts an audit of the security and privacy practices of Subprocessors to ensure Subprocessors provide a level of security and privacy appropriate to their access to data and the scope of the services they are engaged to provide. 9. Data Privacy Office. The Data Privacy Office of the Data Importer can be contacted by the Data Exporter’s administrators using the mechanism defined at: https://auth0.com/privacy (or via such other means as may be provided by the Data Importer).
    By clicking "Accept", you acknowledge that you have read, understood and agree to be legally bound by the European Commission Model Contract Clauses (processors), as well as our Terms of Service and Privacy Policy. If you are accepting these clauses on behalf of a company or other legal entity, you represent that you have the authority to bind such company or legal entity. You may download and print these clauses at any time.

    https://manage.auth0.com/#/
    https://manage.auth0.com/#/applications/eD2I5SEBmvgx3tEzeFd35mJfvW5HkasK/quickstart

    - [ ] Add dependencies

      [[Gemfile]]

      : gem 'ominauth', '~> 1.3'

    - [ ] Initialize Omniauth AuthO
    - [ ] Add the AuthO callback handler
    - [ ] Specify the callback on AuthO Dashboard
    - [ ] Triggering login manually or integrating the AuthOLock
    - [ ] Accessing user information
    - [ ] You're done!

*** nb

    - oauth?
      - login with familiar accounts
        - google, fb, twitter, etc
          

** Views

*** Routes

    [[./config/routes.rb]]

    #+NAME: routes.rb
    #+begin_src ruby :tangle config/routes.rb :padline no
      Rails.application.routes.draw do
        root 'spreadsheets#new'

        resources :spreadsheets

        get "spreadsheets" => "spreadsheets#new"
      end
    #+end_src

    [[Custom Endpoints]]

*** Static Pages

    : root 'pages#home'    

    [[Pages]]

**** Home

     [[./app/views/pages/home.html.erb]]

** Controllers

*** Pages

    Static pages controller

    #+begin_src sh
      rails g controller pages --skip-assets
    #+end_src

    #+RESULTS:
    | create | app/controllers/pages_controller.rb       |
    | invoke | erb                                       |
    | create | app/views/pages                           |
    | invoke | test_unit                                 |
    | create | test/controllers/pages_controller_test.rb |
    | invoke | helper                                    |
    | create | app/helpers/pages_helper.rb               |
    | invoke | test_unit                                 |

*** Spreadsheets

** Models

*** Page
*** Spreadsheet

    [[./app/models/spreadsheet.rb]]

    #+NAME: spreadsheet.rb
    #+begin_src ruby :tangle app/models/spreadsheet.rb :padline no
      class Spreadsheet < ActiveRecord::Base
        dragonfly_accessor :file  # defines a reader/writer for file
      end
    #+end_src

*** Label
** Classes

*** SpreadsheetPdf

    : mkdir ./app/pdfs

    [[./app/pdfs/spreadsheet_pdf.rb]]

    #+NAME: SpreadsheetPdf
    #+begin_src ruby :tangle app/pdfs/spreadsheet_pdf.rb :padline no
      class SpreadsheetPdf < Prawn::Document

        def initialize(spreadsheet, view)
          super()
          @spreadsheet = spreadsheet
          file_path = "public/system/dragonfly/development"
          xls_file = get_labels("#{file_path}/#{@spreadsheet.file_uid}")
          @view = view

          make_labels(xls_file)

        end

        def desc_box(desc)
          formatted_text_box [
            {
              text: "#{desc}",
              color: "ffffff",
              styles: [:italic],
              size: 11
            }
          ], at: [$padding,$top], width: $text_width
        end

        def size_box(gauge,size)
          transparent(0.1) do
            stroke_rectangle [0, $box_height+$padding], $box_width, $box_height*0.75
          end

          transparent(0.6) do
            formatted_text_box [
              {
                text: "#{gauge} #{size}",
                color: "ffffff",
                size: 15,
                styles: [:normal],
                character_spacing: 0.5
              }
            ], at: [($box_width/2)-$padding,$mid], width: $text_width
          end

        end

        def id_box(id)
          formatted_text_box [
            {
              text: "#{id}",        
              color: "ffffff",
              align: :left
            }
          ], at: [$padding,$low], width: $text_width
        end

        def price_box(price)
          formatted_text_box [
            {
              text: "#{price}",
              color: "ffffff",
              align: :right,
              styles: [:italic]
            }
          ], at: [$box_width-($padding*3),$low], width: $text_width
        end
        
        def make_labels(file)
          
          define_grid(:columns => 4, :rows => 8, :row_gutter => 10, :column_gutter => 0)
          margin = 14
          
          count = 1
          row = 0
          column = 0

          start_new_page(:margin => margin)
          
          file.each do |label|
            
            grid(row, column).bounding_box do
              #stroke_axis

              fill_color "000000"
              stroke_color "ffffff"

              $box_width = 144
              $box_height = 81
              $padding = 12
              $text_width = 90
              $top = $box_height-$padding
              $mid = $top - 30
              $low = $mid - 20
              
              transparent(0.9) do
                fill_rectangle [0, $box_height], $box_width, $box_height
                
                font "Times-Roman", :size => 10

                desc_box(label.desc)
                size_box(label.gauge, label.size)
                id_box(label.id)
                price_box(label.price)
              end

            end

            if count%4 == 0
              row+=1
              column = 0
            else
              column+=1
            end

            if count%32 == 0
              start_new_page(:margin => margin)
              row = 0
              column = 0
            end
            
            count+=1
          end

        end

        def logo
          logopath = "#{Rails.root}/app/assets/images/logo.png"
          image logopath, :width => 197, :height => 197
        end

        def get_labels(file)

          labels = []
          
          xls_file = Roo::Spreadsheet.open(file, extension: :xlsx)

          xls_file.sheets.each do |sheet|

            sheet = xls_file.sheet(sheet)
            
            sheet.parse[0..-1].each do |row|

              zero,one,two,four,five,ten = nil_convert(row[0]),
              nil_convert(row[1]),
              nil_convert(row[2]),
              nil_convert(row[4]),
              nil_convert(row[5]),
              nil_convert(row[10])

              sizes = strip(five.to_s)
              gauge = "#{sizes[0]}g" unless sizes[0].nil?
              size = "#{sizes[1]}\"" unless sizes[1].nil?
              desc = two.gsub("&", "and")
              id = one.to_s.split(/-/)[0]
              price = "$#{four.to_s.split(".")[0]}"
              supply = five
              updated = Chronic.parse(ten).to_f

              label = Label.new(gauge,
                                size,
                                desc,
                                id,
                                price,
                                supply,
                                updated
                               )

              seconds = 60*60*24*@spreadsheet.days.to_f
              
              if (Time.now.to_f - updated.to_f) < seconds
                #puts label.id
                $labelID = label.id
                labels.push label
              end

            end
          end

          return labels

        end

        def nil_convert(c)
          if c.nil? 
            ""
          else
            c
          end
        end

        def strip(s)
          s.gsub(/"/, '').
            gsub(/g/, '').
            gsub(/G/, '').
            gsub(/,/, '').
            split(' ')
        end

      end
    #+end_src

    - nb

      [[Prawn]]

      [[Spreadsheets]]

*** Label

    [[./app/pdfs/label.rb]]

    #+NAME: Label
    #+begin_src ruby :tangle app/pdfs/label.rb :padline no
      class Label

        def initialize(gauge, size, desc, id, price, supply, updated)
          @gauge = gauge
          @size = size
          @desc = desc
          @id = id
          @price = price
          @supply = supply
          @updated = updated
        end

        attr_reader :gauge, :size, :desc, :id, :price, :supply, :updated

      end

    #+end_src


** TODO

   - [ ] Testing
   - [ ] sidekiq
     - [ ] background processes for creating pdfs?
   - [-] requirements
     - [X] roo
     - [X] chronic
     - [ ] [[Prawn]]
   - [X] migrate code from cj-parser
   - [ ] user authentication
     
     

   - [ ] file upload
     - [ ] only xlsx file?
     - [ ] AWS
   - [ ] file storage
     - [ ] archival api?
   - [ ] production
     - [ ] heroku
       - [ ] secrets

