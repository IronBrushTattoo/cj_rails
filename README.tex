% Created 2016-05-06 Fri 01:23
\documentclass[11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{fixltx2e}
\usepackage{graphicx}
\usepackage{longtable}
\usepackage{float}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{textcomp}
\usepackage{marvosym}
\usepackage{wasysym}
\usepackage{amssymb}
\usepackage{hyperref}
\tolerance=1000
\author{AnderSon}
\date{Tue May  3 10:45:24 CDT 2016}
\title{\textbf{Iron Brush Tattoo} \emph{Case Jewelry}}
\hypersetup{
  pdfkeywords={},
  pdfsubject={},
  pdfcreator={Emacs 24.5.1 (Org mode 8.2.10)}}
\begin{document}

\maketitle
\tableofcontents

\emph{Rails 4.2.6}

\url{https://github.com/IronBrushTattoo/cj_rails.git}

\section{Config}
\label{sec-1}

\subsection{Gemfile}
\label{sec-1-1}

\url{./Gemfile}

\begin{verbatim}
source 'https://rubygems.org'

gem 'rails', '4.2.6'
gem 'pg', '~> 0.15'
gem 'sass-rails', '~> 5.0'
gem 'uglifier', '>= 1.3.0'
gem 'coffee-rails', '~> 4.1.0'
gem 'jquery-rails'
gem 'turbolinks'
gem 'jbuilder', '~> 2.0'
gem 'sdoc', '~> 0.4.0', group: :doc
gem 'dragonfly', '~> 1.0.12'
gem 'rack-cache', :require => 'rack/cache'
#gem 'prawn', '~> 2.1'
gem 'prawn'

group :development, :test do
  gem 'byebug'
end

group :development do
  gem 'web-console', '~> 2.0'
  gem 'spring'
end
\end{verbatim}

\subsection{Gems}
\label{sec-1-2}

\ref{sec-3-2-1}
\ref{sec-3-3-2-1}

\section{First steps}
\label{sec-2}

\begin{verbatim}
rake db:migrate
rake db:setup
\end{verbatim}
\section{Project}
\label{sec-3}

The purpose of this application is to produce several pdf files from an xlsx file,
as a re-implementation of \url{https://github.com/IronBrushTattoo/cj} as a web 
application.

\subsection{User Story}
\label{sec-3-1}

\begin{itemize}
\item user logs in (\ref{sec-3-4})
\begin{itemize}
\item users will be piercers
\end{itemize}
\item chooses xlsx file for upload
\ref{sec-3-2}
\item selects number of days back to make labels from
\item submits
\begin{itemize}
\item BACKGROUND
\begin{itemize}
\item cj-parser.rb does what it does\ldots{}
\begin{itemize}
\item $\square$ rewrite in rails?
\end{itemize}
\end{itemize}
\end{itemize}
\item downloads sheets(pdf files)
\end{itemize}

\subsection{File Upload}
\label{sec-3-2}

\begin{itemize}
\item possible gems
\url{https://www.ruby-toolbox.com/categories/rails_file_uploads}

\begin{itemize}
\item paperclip
\begin{itemize}
\item nb
\begin{itemize}
\item used paperclip before
\item seemed to be designed specifically for image files
\item always worked well
\end{itemize}
\end{itemize}
\item carrierwave
\begin{itemize}
\item nb
\begin{itemize}
\item used before, but not thoroughly
\begin{itemize}
\item i kind of remember having issues with it
\end{itemize}
\end{itemize}
\end{itemize}
\item dragonfly
\url{https://github.com/markevans/dragonfly}
\url{http://markevans.github.io/dragonfly/}
\url{http://markevans.github.io/dragonfly/rails/}

Dragonfly is a highly customizable ruby gem for handling images and other
attachments and is already in use on thousands of websites

\ref{sec-3-2-1}

\begin{itemize}
\item nb
\begin{itemize}
\item used briefly before
\begin{itemize}
\item i remember it being an easy configuration
\end{itemize}
\end{itemize}
\end{itemize}
\item attachment fu
\url{https://github.com/technoweenie/attachment_fu}

Treat an ActiveRecord model as a file attachment, storing its patch, size,
content type, etc. \url{http://weblog.technoweenie.net}

\begin{itemize}
\item nb
\begin{itemize}
\item has not been maintained since Apr 25, 2009
\end{itemize}
\end{itemize}
\item refile
\begin{itemize}
\item nb
\begin{itemize}
\item was my next choice when previously working with file uploads
\end{itemize}
\end{itemize}
\item jquery.fileupload-rails
\item imagery
\item attached
\item papermill
\item fileuploader-rails
\item filecip
\item simple-image-uploader
\end{itemize}
\end{itemize}

\subsubsection{Dragonfly}
\label{sec-3-2-1}

\url{http://markevans.github.io/dragonfly/rails/}

\begin{enumerate}
\item Setup
\label{sec-3-2-1-1}

\begin{itemize}
\item $\boxtimes$ gem 'dragonfly', '\textasciitilde{}> 1.0.12'

\begin{itemize}
\item $\boxtimes$ modify \ref{Gemfile}

\item $\boxtimes$ bundle install
\end{itemize}

\item $\boxtimes$ rails g dragonfly

generates config/initializers/dragonfly.rb

\url{./config/initializers/dragonfly.rb}

\begin{verbatim}
require 'dragonfly'

# Configure
Dragonfly.app.configure do
  plugin :imagemagick

  secret "72245c7371d66ccca6f9356779fa16e3104e6676c1e57af987e9e3f92130dca5"

  url_format "/media/:job/:name"

  datastore :file,
    root_path: Rails.root.join('public/system/dragonfly', Rails.env),
    server_root: Rails.root.join('public')
end

# Logger
Dragonfly.logger = Rails.logger

# Mount as middleware
Rails.application.middleware.use Dragonfly::Middleware

# Add model functionality
if defined?(ActiveRecord::Base)
  ActiveRecord::Base.extend Dragonfly::Model
  ActiveRecord::Base.extend Dragonfly::Model::Validations
end
\end{verbatim}
\end{itemize}

\item Handling attachments
\label{sec-3-2-1-2}

\begin{itemize}
\item example (replace Photo model with Spreadsheet)

Model: \emph{Photo}

\begin{itemize}
\item add \emph{image} attribute to Photo

\begin{verbatim}
class Photo < ActiveRecord::Base
  dragonfly_accessor :image  # defines a reader/writer for image
  # ...
end
\end{verbatim}

\item needs \emph{image$_{\text{uid}}$} column, create migration with

\begin{verbatim}
rails g migration 
\end{verbatim}

\begin{verbatim}
add_column :photos, :image_uid, :string
add_column :photos, :image_name, :string  # Optional - if you want 
                                          # urls to end with the 
                                          # original filename
\end{verbatim}

\item view for uploading

\begin{verbatim}
app/views/photos/...
\end{verbatim}

\begin{verbatim}
<% form_for @photo do |f| %>
  ...
  <%= f.file_field :image %>
  ...
<% end %>
\end{verbatim}

\item allow parameter \emph{image} to be accepted by the controller

\begin{verbatim}
app/controllers/photos_controller.rb
\end{verbatim}

\begin{verbatim}
params.require(:photo).permit(:image)
\end{verbatim}

\item view for displaying

\begin{verbatim}
<%= image_tag @photo.image.thumb('400x200#').url if @photo.image_stored? %>
\end{verbatim}

\item more can be done with \href{http://markevans.github.io/dragonfly/models}{models}
\end{itemize}

\item Spreadsheet model sketch based on above example

Model: \emph{Spreadsheet}

\ref{sec-3-7-2}

\begin{itemize}
\item $\boxtimes$ add \emph{file} attribute to Spreadsheet

\begin{verbatim}
class Spreadsheet < ActiveRecord::Base
  dragonfly_accessor :file  # defines a reader/writer for file
  # ...
end
\end{verbatim}

\item $\boxtimes$ needs \emph{file$_{\text{uid}}$} column, create migration with

\begin{verbatim}
rails g migration AddFileUidToSpreadsheets file_uid:string
rails g migration AddFileNameToSpreadsheets file_name:string
\end{verbatim}

\url{./db/migrate/20160504011342_add_file_uid_to_spreadsheets.rb}
\url{./db/migrate/20160504011542_add_file_name_to_spreadsheets.rb}

\begin{verbatim}
add_column :spreadsheets, :file_uid, :string
add_column :spreadsheets, :file_name, :string  # Optional - if you want 
                                               # urls to end with the 
                                               # original filename
\end{verbatim}

\begin{verbatim}
rake db:migrate
\end{verbatim}

\item $\boxtimes$ view for uploading

\url{./app/views/spreadsheets/}

\begin{verbatim}
<% form_for @spreadsheet do |f| %>
  ...
  <%= f.file_field :file %>
  ...
<% end %>
\end{verbatim}

\item $\boxtimes$ allow parameter \emph{file} to be accepted by the controller

\url{./app/controllers/spreadsheets_controller.rb}

\begin{verbatim}
params.require(:spreadsheet).permit(:file)
\end{verbatim}

\begin{verbatim}
class SpreadsheetsController < ApplicationController
  before_action :set_spreadsheet, only: [:show, :edit, :update, :destroy]

  def index
    @spreadsheets = Spreadsheet.all
  end

  def show
    @spreadsheet = Spreadsheet.find(params[:id])
    respond_to do |format|
      format.html
      format.pdf do
        pdf = SpreadsheetPdf.new(@spreadsheet, view_context)
        send_data pdf.render,
                  filename: "spreadsheet_#{@spreadsheet.created_at.strftime("%d/%m/%Y")}.pdf",
                  type: "application/pdf",
                  disposition: "inline"
      end
    end
  end

  def new
    @spreadsheet = Spreadsheet.new
  end

  def edit
  end

  def create
    @spreadsheet = Spreadsheet.new(spreadsheet_params)

    respond_to do |format|
      if @spreadsheet.save
        format.html { redirect_to @spreadsheet, notice: 'Spreadsheet was successfully created.' }
        format.json { render :show, status: :created, location: @spreadsheet }
      else
        format.html { render :new }
        format.json { render json: @spreadsheet.errors, status: :unprocessable_entity }
      end
    end
  end

  def update
    respond_to do |format|
      if @spreadsheet.update(spreadsheet_params)
        format.html { redirect_to @spreadsheet, notice: 'Spreadsheet was successfully updated.' }
        format.json { render :show, status: :ok, location: @spreadsheet }
      else
        format.html { render :edit }
        format.json { render json: @spreadsheet.errors, status: :unprocessable_entity }
      end
    end
  end

  def destroy
    @spreadsheet.destroy
    respond_to do |format|
      format.html { redirect_to spreadsheets_url, notice: 'Spreadsheet was successfully destroyed.' }
      format.json { head :no_content }
    end
  end

  private
  def set_spreadsheet
    @spreadsheet = Spreadsheet.find(params[:id])
  end

  def spreadsheet_params
    params.require(:spreadsheet).permit(:index, :file)
  end
end
\end{verbatim}

\begin{itemize}
\item nb

\ref{sec-3-3-2-1}
\ref{sec-3-3-2-1-3-1}
\end{itemize}

\item $\boxtimes$ view for displaying

\url{./app/views/spreadsheets/show.html.erb}
\url{./app/views/spreadsheets/index.html.erb}

\begin{verbatim}
<%= @spreadsheet.file_name if @spreadsheet.file_stored? %>
\end{verbatim}

\item more can be done with \href{http://markevans.github.io/dragonfly/models}{models}
\end{itemize}
\end{itemize}

\item Caching
\label{sec-3-2-1-3}

\begin{itemize}
\item $\boxtimes$ \ref{Gemfile}

\begin{verbatim}
gem 'rack-cache', :require => 'rack/cache'
\end{verbatim}

\begin{itemize}
\item $\boxtimes$ bundle install
\end{itemize}

\item $\boxtimes$ uncomment in \texttt{Production}

\begin{verbatim}
config.action_dispatch.rack_cache = true
\end{verbatim}
\end{itemize}

\item Custom Endpoints
\label{sec-3-2-1-4}

\ref{sec-3-5-1}

\begin{itemize}
\item $\square$ text generation example

\begin{verbatim}
get "text/:text" => Dragonfly.app.endpoint { |params, app|
  app.generate(:text, params[:text], 'font-size' => 42)
}
\end{verbatim}

\item $\square$ endpoint callable from javascript (e.g. /image?file=egg.png\&size=30x30)

\begin{verbatim}
get "image" => Dragonfly.app.endpoint { |params, app|
  app.fetch_file("some/dir/#{params[:file]}").thumb(params[:size])
}
\end{verbatim}
\end{itemize}
\end{enumerate}

\subsection{File Conversion}
\label{sec-3-3}

\subsubsection{xlsx processing}
\label{sec-3-3-1}

\begin{itemize}
\item roo
\end{itemize}

\subsubsection{latex processing}
\label{sec-3-3-2}

\begin{enumerate}
\item Prawn
\label{sec-3-3-2-1}
\url{https://github.com/prawnpdf/prawn}

\begin{enumerate}
\item Setup
\label{sec-3-3-2-1-1}

\begin{itemize}
\item $\boxtimes$ \ref{Gemfile}
\end{itemize}
\begin{verbatim}
#gem 'prawn', '~> 2.1'
gem 'prawn'
\end{verbatim}

\begin{itemize}
\item $\boxtimes$ bundle install
\end{itemize}

\begin{enumerate}
\item Manual
\label{sec-3-3-2-1-1-1}

\url{http://prawnpdf.org/manual.pdf}

\begin{itemize}
\item $\boxtimes$ clone repository

\begin{verbatim}
git clone https://github.com/prawnpdf/prawn
\end{verbatim}

\item $\square$ switch to the stable branch 

\begin{verbatim}
git branch stable
\end{verbatim}

\item $\boxtimes$ bundle install

\item $\square$ bundle exec rake manual
generates \emph{manual.pdf} in the project root
\end{itemize}
\end{enumerate}

\item basic$_{\text{concepts}}$/creation.rb
\label{sec-3-3-2-1-2}

\begin{verbatim}
Prawn::Document
Prawn::Document.generate
\end{verbatim}

\item Tutorials
\label{sec-3-3-2-1-3}
\begin{enumerate}
\item Creating PDF Using Prawn in Ruby on Rails
\label{sec-3-3-2-1-3-1}

\url{http://www.idyllic-software.com/blog/creating-pdf-using-prawn-in-ruby-on-rails/}

\begin{itemize}
\item $\boxtimes$ \ref{Gemfile}

\begin{verbatim}
gem 'prawn'
bundle install
\end{verbatim}

\item $\boxtimes$ \url{./config/initializers/mime_types.rb}

create a PDF Mime::Type inside mime$_{\text{types}}$.rb

\begin{verbatim}
# Be sure to restart your server when you modify this file.

# Add new mime types for use in respond_to blocks:
# Mime::Type.register "text/richtext", :rtf

Mime::Type.register "application/pdf", :pdf
\end{verbatim}

\item $\boxtimes$ \url{./app/controllers/spreadsheets_controller.rb}

\ref{sec-3-6-2}

\url{http://www.idyllic-software.com/blog/creating-pdf-using-prawn-in-ruby-on-rails/}

\begin{verbatim}
class InvoicesController < ApplicationController

  before_filter :authenticate_customer!, :only => [:index, :show]

  def index
    @invoices = Invoice.all_invoices(current_customer)
  end

  def show
    @invoice = Invoice.find(params[:id])
    respond_to do |format|
      format.html
      format.pdf do
        pdf = InvoicePdf.new(@invoice, view_context)
        send_data pdf.render, filename: 
          "invoice_#{@invoice.created_at.strftime("%d/%m/%Y")}.pdf",
          type: "application/pdf"
      end
    end
  end

end
\end{verbatim}

\begin{itemize}
\item $\boxtimes$ open pdf in browser instead of download

add /disposition: "inline"/ after type
\end{itemize}

\item $\boxtimes$ create a new class \textbf{app/pdfs/spreadsheet$_{\text{pdf}}$}

\ref{sec-3-8-1}

\ref{sec-3-6-2}

\item $\boxtimes$ restart server

\item $\boxtimes$ \ref{sec-3-8-1}

set the \emph{@spreadsheet} and \emph{view$_{\text{context}}$}

\begin{verbatim}
def initialize(spreadsheet, view)
  super()
  @spreadsheet = spreadsheet
  @view = view
  text "Spreadsheet #{@spreadsheet.id}"
end
\end{verbatim}

\item $\square$ create different methods inside \ref{sec-3-8-1} as per what you want to show on the pdf

\begin{itemize}
\item example

\begin{verbatim}
def logo
  logopath = "#{Rails.root}/app/assets/images/logo.png"
  image logopath, :width => 197, :height => 91
end
\end{verbatim}
\end{itemize}
\end{itemize}

\begin{enumerate}
\item Issues
\label{sec-3-3-2-1-3-1-1}

\begin{itemize}
\item $\square$ NameError (uninitialized constant SpreadsheetsController::SpreadsheetPdf)
\end{itemize}
\end{enumerate}
\end{enumerate}
\end{enumerate}



\item nb
\label{sec-3-3-2-2}
\url{https://rubygems.org/search?utf8=\%E2\%9C\%93&query=latex}
\url{http://www.sitepoint.com/hackable-pdf-typesetting-in-ruby-with-prawn/}

\url{https://github.com/prawnpdf/prawn}

\ref{sec-3-3-2-1} is active and looks rad!

\begin{itemize}
\item outdated but possibly useful

\url{https://github.com/baierjan/rails-latex}
\url{https://github.com/bruce/rtex}
\end{itemize}
\end{enumerate}

\subsection{Authentication}
\label{sec-3-4}
\subsection{Views}
\label{sec-3-5}

\subsubsection{Routes}
\label{sec-3-5-1}

\url{./config/routes.rb}

\begin{verbatim}
Rails.application.routes.draw do
  root 'pages#home'

  resources :spreadsheets

  get "spreadsheets" => "spreadsheets#new"

  # The priority is based upon order of creation: first created -> highest priority.
  # See how all your routes lay out with "rake routes".

  # You can have the root of your site routed with "root"
  # root 'welcome#index'

  # Example of regular route:
  #   get 'products/:id' => 'catalog#view'

  # Example of named route that can be invoked with purchase_url(id: product.id)
  #   get 'products/:id/purchase' => 'catalog#purchase', as: :purchase

  # Example resource route (maps HTTP verbs to controller actions automatically):
  #   resources :products

  # Example resource route with options:
  #   resources :products do
  #     member do
  #       get 'short'
  #       post 'toggle'
  #     end
  #
  #     collection do
  #       get 'sold'
  #     end
  #   end

  # Example resource route with sub-resources:
  #   resources :products do
  #     resources :comments, :sales
  #     resource :seller
  #   end

  # Example resource route with more complex sub-resources:
  #   resources :products do
  #     resources :comments
  #     resources :sales do
  #       get 'recent', on: :collection
  #     end
  #   end

  # Example resource route with concerns:
  #   concern :toggleable do
  #     post 'toggle'
  #   end
  #   resources :posts, concerns: :toggleable
  #   resources :photos, concerns: :toggleable

  # Example resource route within a namespace:
  #   namespace :admin do
  #     # Directs /admin/products/* to Admin::ProductsController
  #     # (app/controllers/admin/products_controller.rb)
  #     resources :products
  #   end
end
\end{verbatim}

\ref{sec-3-2-1-4}

\subsubsection{Static Pages}
\label{sec-3-5-2}

\begin{verbatim}
root 'pages#home'    
\end{verbatim}

\ref{sec-3-6-1}

\begin{enumerate}
\item Home
\label{sec-3-5-2-1}

\url{./app/views/pages/home.html.erb}
\end{enumerate}

\subsection{Controllers}
\label{sec-3-6}

\subsubsection{Pages}
\label{sec-3-6-1}

Static pages controller

\begin{verbatim}
rails g controller pages --skip-assets
\end{verbatim}

\subsubsection{Spreadsheets}
\label{sec-3-6-2}

\subsection{Models}
\label{sec-3-7}

\subsubsection{Page}
\label{sec-3-7-1}
\subsubsection{Spreadsheet}
\label{sec-3-7-2}

\url{./app/models/spreadsheet.rb}

\begin{verbatim}
class Spreadsheet < ActiveRecord::Base
  dragonfly_accessor :file  # defines a reader/writer for file
end
\end{verbatim}

\subsubsection{Label}
\label{sec-3-7-3}
\subsection{Classes}
\label{sec-3-8}

\subsubsection{SpreadsheetPdf}
\label{sec-3-8-1}

\begin{verbatim}
mkdir ./app/pdfs
\end{verbatim}

\url{./app/pdfs/spreadsheet_pdf.rb}

\begin{verbatim}
class SpreadsheetPdf < Prawn::Document

  def initialize(spreadsheet, view)
    super()
    @spreadsheet = spreadsheet
    @view = view
    logo
    text "This is a sheet of labels for selected case jewelry, #{@spreadsheet.id}"
  end

  def logo
    logopath = "#{Rails.root}/app/assets/images/logo.png"
    image logopath, :width => 197, :height => 197
  end

end
\end{verbatim}

\begin{itemize}
\item nb

\ref{sec-3-3-2-1}
\end{itemize}

\subsection{{\bfseries\sffamily TODO} }
\label{sec-3-9}

\begin{itemize}
\item $\square$ Tests
\item $\square$ sidekiq
\begin{itemize}
\item $\square$ background processes for creating pdfs
\end{itemize}
\item $\square$ requirements
\begin{itemize}
\item $\square$ roo
\item $\square$ chronic
\end{itemize}
\item $\square$ pdflatex

\ref{sec-3-3-2-1}

\item $\square$ migrate code from cj-parser
\item $\square$ user authentication
\item $\square$ file upload
\begin{itemize}
\item $\square$ only xlsx file?
\item $\square$ AWS
\end{itemize}
\item $\square$ file storage
\begin{itemize}
\item $\square$ archival api?
\end{itemize}
\end{itemize}
% Emacs 24.5.1 (Org mode 8.2.10)
\end{document}
